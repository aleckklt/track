{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Historique des connexions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-5">
    <h2 class="text-center mb-4">Historique des connexions</h2>
    
    <table class="table table-striped table-bordered text-center" id="historyTable">
        <thead class="table-dark">
            <tr>
                <th>Nom d'utilisateur</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Email</th>
                <th>Date de connexion</th>
                <th>Date de déconnexion</th>
                <th>Temps de connexion</th>
            </tr>
        </thead>
        <tbody>
        {% for entry in history %}
            <tr>
                <td>{{ entry.user.username }}</td>
                <td>{{ entry.user.last_name }}</td>
                <td>{{ entry.user.first_name }}</td>
                <td>{{ entry.user.email }}</td>
                <td>{{ entry.login_time }}</td>
                <td>{{ entry.logout_time|default:"-" }}</td>
                <td>{{ entry.time_connexion|default:"-" }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="7">Aucun historique trouvé.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="text-center mt-4">
        <a href="{% url 'home' %}" class="btn btn-primary">Retour à l'accueil</a>
    </div>
</div>

<script>
const socket = new WebSocket(`ws://${window.location.host}/ws/admin/notifications/`);

socket.onopen = () => console.log("Connexion WebSocket établie.");

socket.onmessage = (event) => {
  try {
    const data = JSON.parse(event.data);

    if (data.type === "user_event") {
      ajouterLigneAdmin(data);
    } else {
      console.log("Message WebSocket reçu :", data);
    }
  } catch (e) {
    console.error("Erreur JSON:", e);
  }
};

socket.onerror = (error) => console.error("Erreur WebSocket :", error);

socket.onclose = (event) => {
  if (event.wasClean) {
    console.log(`Connexion fermée proprement (code=${event.code}, raison=${event.reason})`);
  } else {
    console.warn("Connexion WebSocket interrompue");
  }
};

function ajouterLigneAdmin(data) {
  const tbody = document.getElementById("historyTableBody");
  if (!tbody) return;

  const tr = document.createElement("tr");

  const username = data.user.username || "-";
  const nom = data.user.last_name || "-";
  const prenom = data.user.first_name || "-";
  const email = data.user.email || "-";
  const loginTime = new Date(data.login_time).toLocaleString();
  const logoutTime = data.logout_time ? new Date(data.logout_time).toLocaleString() : "-";
  const duree = data.session_duration || "-";

  tr.innerHTML = `
    <td>${username}</td>
    <td>${nom}</td>
    <td>${prenom}</td>
    <td>${email}</td>
    <td>${loginTime}</td>
    <td>${logoutTime}</td>
    <td>${duree}</td>
  `;
  tbody.prepend(tr);
}
</script>

</body>
</html>