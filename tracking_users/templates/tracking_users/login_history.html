{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Historique des connexions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-5">
    <h2 class="text-center mb-4">Historique des connexions</h2>
    
    <table class="table table-striped table-bordered text-center" id="historyTable">
        <thead class="table-dark">
            <tr>
                <th>Nom d'utilisateur</th>
                <th>Email</th>
                <th>Date de connexion</th>
                <th>Date de déconnexion</th>
                <th>Temps de connexion</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
        {% for entry in history %}
            <tr>
                <td>{{ entry.user.username }}</td>
                <td>{{ entry.user.email }}</td>
                <td>{{ entry.login_time }}</td>
                <td>{{ entry.logout_time|default:"-" }}</td>
                <td>{{ entry.session_duration|default:"-" }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="7">Aucun historique trouvé.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="text-center mt-4">
        <a href="{% url 'home' %}" class="btn btn-primary">Retour à l'accueil</a>
    </div>
</div>

<script>
const socket = new WebSocket(`ws://${window.location.host}/ws/admin/notifications/`);

socket.onopen = () => {
    console.log(" Connexion WebSocket établie avec le serveur.");
};

socket.onerror = (error) => {
    console.error(" Erreur WebSocket :", error);
};

socket.onclose = (event) => {
    if (event.wasClean) {
        console.log(` Connexion WebSocket fermée proprement (code=${event.code}, raison=${event.reason})`);
    } else {
        console.warn(" Connexion WebSocket interrompue !");
    }
};

socket.onmessage = (event) => {
    try {
        const data = JSON.parse(event.data);

        if (data.type === "user_event") {
            updateHistoryTable(data);
        } else {
            console.log("Message WebSocket inconnu :", data);
        }
    } catch (error) {
        console.error("Erreur de parsing JSON :", error);
    }
};

function updateHistoryTable(data) {
    const tbody = document.getElementById("historyTableBody");
    if (!tbody) return;

    const user = data.user || {};
    const username = user.username || "-";
    const nom = user.last_name || "-";
    const prenom = user.first_name || "-";
    const email = user.email || "-";
    const loginTime = formatDate(data.login_time);
    const logoutTime = data.logout_time ? formatDate(data.logout_time) : "-";
    const duree = data.session_duration || "-";

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${username}</td>
        <td>${nom}</td>
        <td>${prenom}</td>
        <td>${email}</td>
        <td>${loginTime}</td>
        <td>${logoutTime}</td>
        <td>${duree}</td>
    `;
    tbody.prepend(tr);
}

function formatDate(isoString) {
    if (!isoString) return "-";
    const date = new Date(isoString);
    return date.toLocaleString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}
</script>

</body>
</html>