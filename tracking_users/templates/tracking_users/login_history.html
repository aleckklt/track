{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Historique des connexions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-5">
    <h2 class="text-center mb-4">Historique des connexions</h2>
    
    <table class="table table-striped table-bordered text-center" id="historyTable">
        <thead class="table-dark">
            <tr>
                <th>Nom d'utilisateur</th>
                <th>Statut</th>
                <th>Date de déconnexion</th>
                <th>Temps de connexion</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
        {% for entry in history %}
            <tr>
                <td>{{ entry.user.username }}</td>
                <td>
                    {% if entry.user.is_superuser %}
                        <span class="badge bg-info text-dark">Admin</span>
                    {% else %}
                        <span class="badge bg-secondary">Utilisateur</span>
                    {% endif %}
                    {% if entry.is_connected %}
                        <span class="badge bg-success">Connecté</span>
                    {% else %}
                        <span class="badge bg-danger">Déconnecté</span>
                    {% endif %}
                </td>
                <td>{{ entry.logout_time|date:"d/m/Y H:i:s"|default:"-" }}</td>
                <td>
                    {% if entry.session_duration %}
                        {{ entry.session_duration }}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <td>
                    {% if entry.user.is_active %}
                        <form method="post" action="{% url 'deactivate_user' entry.user.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning btn-sm">Désactiver</button>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'activate_user' entry.user.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm">Activer</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="5">Aucun historique trouvé.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="text-center mt-4">
        <a href="{% url 'home' %}" class="btn btn-primary">Retour à l'accueil</a>
    </div>
</div>

<script>
const socket = new WebSocket(`ws://${window.location.host}/ws/admin/notifications/`);

socket.onopen = () => console.log("Connexion WebSocket établie.");
socket.onerror = (error) => console.error("Erreur WebSocket :", error);
socket.onclose = () => console.warn("Connexion WebSocket fermée.");

socket.onmessage = (event) => {
    try {
        const data = JSON.parse(event.data);
        if (data.type === "user_event") {
            updateHistoryTable(data);
        }
    } catch (error) {
        console.error("Erreur parsing JSON :", error);
    }
};

function updateHistoryTable(data) {
    const tbody = document.getElementById("historyTableBody");
    if (!tbody) return;

    const user = data.user || {};
    const username = user.username || "-";
    const isAdmin = user.is_superuser ? 
        '<span class="badge bg-info text-dark">Admin</span>' : 
        '<span class="badge bg-secondary">Utilisateur</span>';
    const isConnected = data.is_connected ? 
        '<span class="badge bg-success">Connecté</span>' : 
        '<span class="badge bg-danger">Déconnecté</span>';
    const logoutTime = data.logout_time ? formatDate(data.logout_time) : "-";
    const duration = data.session_duration || "-";

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${username}</td>
        <td>${isAdmin} ${isConnected}</td>
        <td>${logoutTime}</td>
        <td>${duration}</td>
        <td>
            <button class="btn btn-sm btn-warning">Désactiver</button>
        </td>
    `;
    tbody.prepend(tr);
}

function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString('fr-FR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
}
</script>

</body>
</html>